#include <Arduino.h>

#define LOCK_SIGNAL_PIN 0
#define KEY_SIGNAL_PIN 2

// Number of seconds between lock signals to indicate window closing intent
#define DOUBLE_PRESS_SECONDS 5
// Number of seconds to keep key signal on for raising windows
#define WINDOW_SECONDS 15
// Number of milliseconds to keep key signal on to lock the doors fully
#define KEYLOCK_MILLIS 500


unsigned long lastLock = 0;

void setup() {

  pinMode(LOCK_SIGNAL_PIN, INPUT);
  pinMode(KEY_SIGNAL_PIN, OUTPUT);
}

#define isLocking() digitalRead(LOCK_SIGNAL_PIN)
#define setKeySignal(i) digitalWrite(KEY_SIGNAL_PIN, i)

#define DOUBLE_PRESS_DELAY (DOUBLE_PRESS_SECONDS * 1000)
#define WINDOW_DELAY (WINDOW_SECONDS * 1000)
#define KEYLOCK_DELAY KEYLOCK_MILLIS

void loop() {
  unsigned long awake = millis();

  unsigned long now = millis();
  if (isLocking()){
    if (now - lastLock > DOUBLE_PRESS_DELAY) {
      delay(200); // The control unit needs a time delay between locking and key signals 
      setKeySignal(1);
      while (millis() - now <= KEYLOCK_DELAY) ;
      setKeySignal(0);
    } else {
      setKeySignal(1);
      while (millis() - now <= WINDOW_DELAY) ;
      setKeySignal(0);
    }
    lastLock = now;
    while (isLocking()) ;
  }
}
